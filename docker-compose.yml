services:
  code:
    image: lscr.io/linuxserver/code-server:4.101.1
    container_name: code-server
    environment:
      PUID: "1000"
      PGID: "1000"
      TZ: "America/Toronto"

      # Read login password from this file on container (re)start
      FILE__PASSWORD: "/config/.gitstrap/codepass.txt"

      # Optional: used by your gitstrap bootstrap flow
      GH_USER: "${GH_USER}"
      GH_PAT: "${GH_PAT}"
      GIT_NAME: "${GIT_NAME}"
      GIT_EMAIL: "${GIT_EMAIL}"
      GIT_REPOS: "${GIT_REPOS}"
      GIT_BASE_DIR: "/config/workspace"

    volumes:
      - code-config:/config1
      - code-config:/config
      - projects:/config/workspace
      - ./settings.json:/config/gitstrap/settings.json:ro
      - ./gitstrap.sh:/custom-cont-init.d/10-gitstrap.sh:ro
      - ./codepass.sh:/custom-cont-init.d/20-codepass.sh:ro
      # (No docker.sock or dockersock-group here anymore)

    ports:
      - ":8443"   # or "8443:8443"

    restart: always

  # Sidecar that watches the password file and restarts the code-server container when it changes
  restartd:
    image: alpine:3.20
    container_name: code-server-restartd
    user: "0:0"                             # needs access to /var/run/docker.sock
    depends_on:
      - code
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - /bin/sh
      - -ceu
      - |
        apk add --no-cache curl socat >/dev/null
        cat >/usr/local/bin/restart-hook <<'EOF'
        #!/usr/bin/env sh
        # read and discard the HTTP request headers until blank line
        while IFS= read -r line; do [ -z "$line" ] && break; done
        # respond immediately
        printf "HTTP/1.1 200 OK\r\nContent-Length: 2\r\nConnection: close\r\n\r\nOK"
        # do the restart in the background (so the client returns fast)
        curl --unix-socket /var/run/docker.sock -s -o /dev/null \
          -X POST http://localhost/v1.41/containers/code-server/restart >/dev/null 2>&1 &
        EOF
        chmod +x /usr/local/bin/restart-hook
        echo "[restartd] listening on :9000 (GET / to restart code-server)"
        exec socat TCP-LISTEN:9000,reuseaddr,fork,keepalive EXEC:/usr/local/bin/restart-hook,setsid
    restart: always



volumes:
  code-config:
  projects:
