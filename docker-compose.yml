services:
  code:
    image: lscr.io/linuxserver/code-server:4.101.1
    container_name: code-server
    environment:
      PUID: "1000"
      PGID: "1000"
      TZ: "America/Toronto"

      # Read login password from this file on container (re)start
      FILE__PASSWORD: "/config/.gitstrap/codepass.txt"

      # Optional: used by your gitstrap bootstrap flow
      GH_USER: "${GH_USER}"
      GH_PAT: "${GH_PAT}"
      GIT_NAME: "${GIT_NAME}"
      GIT_EMAIL: "${GIT_EMAIL}"
      GIT_REPOS: "${GIT_REPOS}"
      GIT_BASE_DIR: "/config/workspace"

    volumes:
      - code-config:/config1
      - code-config:/config
      - projects:/config/workspace
      - ./settings.json:/config/gitstrap/settings.json:ro
      - ./gitstrap.sh:/custom-cont-init.d/10-gitstrap.sh:ro
      - ./codepass.sh:/custom-cont-init.d/20-codepass.sh:ro
      # (No docker.sock or dockersock-group here anymore)

    ports:
      - ":8443"   # or "8443:8443"

    restart: always

  # Sidecar that watches the password file and restarts the code-server container when it changes
  restartd:
    image: alpine:3.20
    container_name: code-server-restartd
    user: "0:0"   # root so it can talk to /var/run/docker.sock
    depends_on:
      - code
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -eu -c '
        apk add --no-cache curl busybox-extras >/dev/null;
        mkdir -p /www/cgi-bin;
        cat >/www/cgi-bin/restart << "EOF"
        #!/usr/bin/env sh
        echo "Status: 200 OK"
        echo "Content-Type: text/plain"
        echo
        echo OK
        curl --unix-socket /var/run/docker.sock -s -o /dev/null -w "[restartd] docker api returned %{http_code}\n" \
          -X POST http://localhost/v1.41/containers/code-server/restart || true
        EOF
        chmod +x /www/cgi-bin/restart
        echo "[restartd] listening on :9000 (GET /cgi-bin/restart to restart code-server)"
        exec busybox httpd -f -p 0.0.0.0:9000 -h /www
      '
    restart: always


volumes:
  code-config:
  projects:
